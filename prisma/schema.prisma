generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// ユーザーモデル（NextAuth統合）
model User {
  id            String    @id @default(cuid())
  name          String?
  email         String    @unique
  emailVerified DateTime?
  image         String?
  createdAt     DateTime  @default(now())
  updatedAt     DateTime  @updatedAt

  // NextAuth関連
  accounts Account[]
  sessions Session[]

  // アプリケーション関連
  pomodoroSessions PomodoroSession[]
  settings         PomodoroSettings?
  dailyStats       DailyStats[]
  categoryStats    CategoryStats[]
  productivityData TimeSlotProductivity[]
  attendanceRecords AttendanceRecord[]
  workLocations    WorkLocation[]
  memos            Memo[]

  @@map("users")
}

// NextAuth - アカウント情報（OAuth等）
model Account {
  id                       String  @id @default(cuid())
  userId                   String
  type                     String
  provider                 String
  providerAccountId        String
  refresh_token            String? @db.Text
  access_token             String? @db.Text
  expires_at               Int?
  token_type               String?
  scope                    String?
  id_token                 String? @db.Text
  session_state            String?
  refresh_token_expires_in Int?

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([provider, providerAccountId])
  @@map("accounts")
}

// NextAuth - セッション情報
model Session {
  id           String   @id @default(cuid())
  sessionToken String   @unique
  userId       String
  expires      DateTime

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@map("sessions")
}

// NextAuth - 認証トークン
model VerificationToken {
  identifier String
  token      String   @unique
  expires    DateTime

  @@unique([identifier, token])
  @@map("verification_tokens")
}

// ポモドーロセッション
model PomodoroSession {
  id               String   @id @default(cuid())
  userId           String
  startTime        DateTime
  endTime          DateTime?
  mode             String // '作業' | '休憩' | '長い休憩'
  category         String // 'Coding' | 'Design' | 'Study' | 'Meeting' | 'Other'
  durationMinutes  Int
  completionStatus String // '完走' | '中断'
  taskId           String? // タスク機能との連携用（オプション）
  createdAt        DateTime @default(now())
  updatedAt        DateTime @updatedAt

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId, startTime])
  @@index([userId, category])
  @@map("pomodoro_sessions")
}

// ポモドーロ設定
model PomodoroSettings {
  id                   String   @id @default(cuid())
  userId               String   @unique
  workDuration         Int      @default(25) // 作業時間（分）
  shortBreakDuration   Int      @default(5) // 短い休憩（分）
  longBreakDuration    Int      @default(15) // 長い休憩（分）
  sessionsUntilLongBreak Int    @default(4) // 長い休憩までのセッション数
  dailyGoal            Int      @default(8) // 1日の目標セッション数
  autoStartBreak       Boolean  @default(false)
  autoStartWork        Boolean  @default(false)
  soundEnabled         Boolean  @default(true)
  createdAt            DateTime @default(now())
  updatedAt            DateTime @updatedAt

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@map("pomodoro_settings")
}

// 日次統計
model DailyStats {
  id                String   @id @default(cuid())
  userId            String
  date              DateTime @unique
  completedSessions Int      @default(0)
  focusMinutes      Int      @default(0)
  goalAchieved      Boolean  @default(false)
  createdAt         DateTime @default(now())
  updatedAt         DateTime @updatedAt

  user              User                @relation(fields: [userId], references: [id], onDelete: Cascade)
  categoryBreakdown CategoryBreakdown[]

  @@index([userId, date])
  @@map("daily_stats")
}

// カテゴリ別内訳（日次統計の詳細）
model CategoryBreakdown {
  id          String   @id @default(cuid())
  dailyStatsId String
  category    String
  minutes     Int
  createdAt   DateTime @default(now())

  dailyStats DailyStats @relation(fields: [dailyStatsId], references: [id], onDelete: Cascade)

  @@index([dailyStatsId])
  @@map("category_breakdown")
}

// カテゴリ別統計（集計用）
model CategoryStats {
  id           String   @id @default(cuid())
  userId       String
  category     String
  totalMinutes Int      @default(0)
  sessionCount Int      @default(0)
  weekStart    DateTime // 集計週の開始日
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([userId, category, weekStart])
  @@index([userId, weekStart])
  @@map("category_stats")
}

// 時間帯別生産性データ
model TimeSlotProductivity {
  id                    String   @id @default(cuid())
  userId                String
  timeSlot              String // '08-10' | '10-12' | '12-14' | '14-16' | '16-18' | '18-20'
  dayOfWeek             Int // 0 (日曜) - 6 (土曜)
  completedSessions     Int      @default(0)
  completionRate        Int      @default(0) // パーセンテージ
  averageFocusMinutes   Int      @default(0)
  productivityScore     Int      @default(0) // 0-100
  weekStart             DateTime // 集計週の開始日
  createdAt             DateTime @default(now())
  updatedAt             DateTime @updatedAt

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([userId, timeSlot, dayOfWeek, weekStart])
  @@index([userId, weekStart])
  @@map("time_slot_productivity")
}

// 勤務先マスタ
model WorkLocation {
  id           String    @id @default(cuid())
  userId       String
  name         String // 勤務先名
  type         String // '時給制' | '日給制' | '業務委託'
  hourlyRate   Int? // 時給（円）
  dailyRate    Int? // 日給（円）
  projectRate  Int? // 単価（業務委託の場合、時間単価）
  color        String   @default("#3B82F6") // UI表示用カラー
  isActive     Boolean  @default(true)
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt

  user              User               @relation(fields: [userId], references: [id], onDelete: Cascade)
  attendanceRecords AttendanceRecord[]

  @@index([userId])
  @@map("work_locations")
}

// 勤怠記録
model AttendanceRecord {
  id             String    @id @default(cuid())
  userId         String
  workLocationId String
  date           DateTime  @db.Date // 勤務日（日付のみ）
  clockIn        DateTime? // 出勤時刻
  clockOut       DateTime? // 退勤時刻
  workMinutes    Int? // 勤務時間（分）自動計算
  note           String?   @db.Text // メモ・備考
  createdAt      DateTime  @default(now())
  updatedAt      DateTime  @updatedAt

  user         User         @relation(fields: [userId], references: [id], onDelete: Cascade)
  workLocation WorkLocation @relation(fields: [workLocationId], references: [id], onDelete: Restrict)

  @@unique([userId, date])
  @@index([userId, date])
  @@index([workLocationId])
  @@map("attendance_records")
}

// メモ（思いついたことをサッと書ける、後でタスク化可能）
model Memo {
  id        String   @id @default(cuid())
  userId    String
  content   String   @db.Text // メモ内容
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId, createdAt])
  @@map("memos")
}
