generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// ユーザーモデル（NextAuth統合）
model User {
  id            String    @id @default(cuid())
  name          String?
  email         String    @unique
  emailVerified DateTime?
  image         String?
  createdAt     DateTime  @default(now())
  updatedAt     DateTime  @updatedAt

  // NextAuth関連
  accounts Account[]
  sessions Session[]

  // アプリケーション関連
  pomodoroSessions PomodoroSession[]
  settings         PomodoroSettings?
  dailyStats       DailyStats[]
  categoryStats    CategoryStats[]
  productivityData TimeSlotProductivity[]
  attendanceRecords AttendanceRecord[]
  workLocations    WorkLocation[]
  memos            Memo[]

  // 会計管理
  clients              Client[]
  transactions         Transaction[]
  accountingSettings   AccountingSettings?
  monthlyFinancialData MonthlyFinancialData[]

  // 学習ログ
  studyLogSettings StudyLogSettings?
  habits           Habit[]
  habitCompletions HabitCompletion[]

  @@map("users")
}

// NextAuth - アカウント情報（OAuth等）
model Account {
  id                       String  @id @default(cuid())
  userId                   String
  type                     String
  provider                 String
  providerAccountId        String
  refresh_token            String? @db.Text
  access_token             String? @db.Text
  expires_at               Int?
  token_type               String?
  scope                    String?
  id_token                 String? @db.Text
  session_state            String?
  refresh_token_expires_in Int?

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([provider, providerAccountId])
  @@map("accounts")
}

// NextAuth - セッション情報
model Session {
  id           String   @id @default(cuid())
  sessionToken String   @unique
  userId       String
  expires      DateTime

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@map("sessions")
}

// NextAuth - 認証トークン
model VerificationToken {
  identifier String
  token      String   @unique
  expires    DateTime

  @@unique([identifier, token])
  @@map("verification_tokens")
}

// ポモドーロセッション
model PomodoroSession {
  id               String   @id @default(cuid())
  userId           String
  startTime        DateTime
  endTime          DateTime?
  mode             String // '作業' | '休憩' | '長い休憩'
  category         String // 'Coding' | 'Design' | 'Study' | 'Meeting' | 'Other'
  durationMinutes  Int
  completionStatus String // '完走' | '中断'
  taskId           String? // タスク機能との連携用（オプション）
  createdAt        DateTime @default(now())
  updatedAt        DateTime @updatedAt

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId, startTime])
  @@index([userId, category])
  @@map("pomodoro_sessions")
}

// ポモドーロ設定
model PomodoroSettings {
  id                   String   @id @default(cuid())
  userId               String   @unique
  workDuration         Int      @default(25) // 作業時間（分）
  shortBreakDuration   Int      @default(5) // 短い休憩（分）
  longBreakDuration    Int      @default(15) // 長い休憩（分）
  sessionsUntilLongBreak Int    @default(4) // 長い休憩までのセッション数
  dailyGoal            Int      @default(8) // 1日の目標セッション数
  autoStartBreak       Boolean  @default(false)
  autoStartWork        Boolean  @default(false)
  soundEnabled         Boolean  @default(true)
  createdAt            DateTime @default(now())
  updatedAt            DateTime @updatedAt

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@map("pomodoro_settings")
}

// 日次統計
model DailyStats {
  id                String   @id @default(cuid())
  userId            String
  date              DateTime @unique
  completedSessions Int      @default(0)
  focusMinutes      Int      @default(0)
  goalAchieved      Boolean  @default(false)
  createdAt         DateTime @default(now())
  updatedAt         DateTime @updatedAt

  user              User                @relation(fields: [userId], references: [id], onDelete: Cascade)
  categoryBreakdown CategoryBreakdown[]

  @@index([userId, date])
  @@map("daily_stats")
}

// カテゴリ別内訳（日次統計の詳細）
model CategoryBreakdown {
  id          String   @id @default(cuid())
  dailyStatsId String
  category    String
  minutes     Int
  createdAt   DateTime @default(now())

  dailyStats DailyStats @relation(fields: [dailyStatsId], references: [id], onDelete: Cascade)

  @@index([dailyStatsId])
  @@map("category_breakdown")
}

// カテゴリ別統計（集計用）
model CategoryStats {
  id           String   @id @default(cuid())
  userId       String
  category     String
  totalMinutes Int      @default(0)
  sessionCount Int      @default(0)
  weekStart    DateTime // 集計週の開始日
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([userId, category, weekStart])
  @@index([userId, weekStart])
  @@map("category_stats")
}

// 時間帯別生産性データ
model TimeSlotProductivity {
  id                    String   @id @default(cuid())
  userId                String
  timeSlot              String // '08-10' | '10-12' | '12-14' | '14-16' | '16-18' | '18-20'
  dayOfWeek             Int // 0 (日曜) - 6 (土曜)
  completedSessions     Int      @default(0)
  completionRate        Int      @default(0) // パーセンテージ
  averageFocusMinutes   Int      @default(0)
  productivityScore     Int      @default(0) // 0-100
  weekStart             DateTime // 集計週の開始日
  createdAt             DateTime @default(now())
  updatedAt             DateTime @updatedAt

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([userId, timeSlot, dayOfWeek, weekStart])
  @@index([userId, weekStart])
  @@map("time_slot_productivity")
}

// 勤務先マスタ
model WorkLocation {
  id           String    @id @default(cuid())
  userId       String
  name         String // 勤務先名
  type         String // '時給制' | '日給制' | '業務委託'
  hourlyRate   Int? // 時給（円）
  dailyRate    Int? // 日給（円）
  projectRate  Int? // 単価（業務委託の場合、時間単価）
  color        String   @default("#3B82F6") // UI表示用カラー
  isActive     Boolean  @default(true)
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt

  user              User               @relation(fields: [userId], references: [id], onDelete: Cascade)
  attendanceRecords AttendanceRecord[]

  @@index([userId])
  @@map("work_locations")
}

// 勤怠記録
model AttendanceRecord {
  id             String    @id @default(cuid())
  userId         String
  workLocationId String
  date           DateTime  @db.Date // 勤務日（日付のみ）
  clockIn        DateTime? // 出勤時刻
  clockOut       DateTime? // 退勤時刻
  workMinutes    Int? // 勤務時間（分）自動計算
  note           String?   @db.Text // メモ・備考
  createdAt      DateTime  @default(now())
  updatedAt      DateTime  @updatedAt

  user         User         @relation(fields: [userId], references: [id], onDelete: Cascade)
  workLocation WorkLocation @relation(fields: [workLocationId], references: [id], onDelete: Restrict)

  @@unique([userId, date])
  @@index([userId, date])
  @@index([workLocationId])
  @@map("attendance_records")
}

// メモ（思いついたことをサッと書ける、後でタスク化可能）
model Memo {
  id        String   @id @default(cuid())
  userId    String
  content   String   @db.Text // メモ内容
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId, createdAt])
  @@map("memos")
}

// ========================================
// 会計管理システム
// ========================================

// 取引先マスタ
model Client {
  id           String   @id @default(cuid())
  userId       String
  name         String // 取引先名（例: 株式会社A）
  type         String // '法人' | '個人'
  contactEmail String? // 連絡先メールアドレス
  contactPhone String? // 連絡先電話番号
  address      String? @db.Text // 住所
  memo         String? @db.Text // メモ
  isActive     Boolean  @default(true)
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt

  user         User          @relation(fields: [userId], references: [id], onDelete: Cascade)
  transactions Transaction[]

  @@index([userId])
  @@index([userId, isActive])
  @@map("clients")
}

// 取引（収入・経費）
model Transaction {
  id          String   @id @default(cuid())
  userId      String
  date        DateTime @db.Date // 取引日
  type        String // '収入' | '経費'
  category    String // 収入: '業務委託' | '広告' | '販売' | 'その他', 経費: '消耗品費' | '通信費' 等
  detail      String // 取引の詳細（例: クライアントA Webデザイン）
  amount      Int // 金額（円）
  clientId    String? // 取引先ID（オプション）
  taxCategory String   @default("課税") // '課税' | '不課税' | '免税' | '対象外'
  memo        String? @db.Text // メモ
  attachments String[] // Supabase Storage のファイルパス配列
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  user   User    @relation(fields: [userId], references: [id], onDelete: Cascade)
  client Client? @relation(fields: [clientId], references: [id], onDelete: SetNull)

  @@index([userId, date])
  @@index([userId, type])
  @@index([userId, category])
  @@map("transactions")
}

// 会計設定
model AccountingSettings {
  id                       String   @id @default(cuid())
  userId                   String   @unique
  fiscalYearStart          Int      @default(1) // 期首月（1-12）
  blueReturnDeduction      Int      @default(650000) // 青色申告特別控除額（円）
  basicDeduction           Int      @default(480000) // 基礎控除（円）
  dependentIncomeLimit     Int      @default(480000) // 扶養ライン目安（円）
  currencyFormat           String   @default("¥") // '¥' | 'JPY'
  displayFormat            String   @default("normal") // 'normal' | 'k' | '万'
  customIncomeCategories   String[] // カスタム収入カテゴリ
  customExpenseCategories  String[] // カスタム経費カテゴリ
  createdAt                DateTime @default(now())
  updatedAt                DateTime @updatedAt

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@map("accounting_settings")
}

// 月別収支データ（集計キャッシュ用）
model MonthlyFinancialData {
  id        String   @id @default(cuid())
  userId    String
  year      Int // 年（例: 2024）
  month     Int // 月（1-12）
  revenue   Int      @default(0) // 売上（円）
  expense   Int      @default(0) // 経費（円）
  profit    Int      @default(0) // 利益（円）= revenue - expense
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([userId, year, month])
  @@index([userId, year])
  @@map("monthly_financial_data")
}

// ========================================
// 学習ログ
// ========================================

// 学習ログ設定
model StudyLogSettings {
  id                String   @id @default(cuid())
  userId            String   @unique
  dailyGoalHours    Float    @default(5.0) // 1日の目標学習時間（時間）
  weeklyGoalHours   Float? // 週間目標学習時間（時間）
  monthlyGoalHours  Float? // 月間目標学習時間（時間）
  customCategories  Json     @default("[]") // カスタムカテゴリ（JSONで保存）
  createdAt         DateTime @default(now())
  updatedAt         DateTime @updatedAt

  user   User    @relation(fields: [userId], references: [id], onDelete: Cascade)
  habits Habit[]

  @@map("study_log_settings")
}

// 習慣（ハビット）
model Habit {
  id                   String   @id @default(cuid())
  userId               String
  studyLogSettingsId   String
  title                String // 習慣の名前（例: "朝の学習"）
  description          String? @db.Text // 詳細説明
  category             String? // 学習カテゴリ（任意）
  targetDays           Int[] // 対象曜日（0:日-6:土）
  isActive             Boolean  @default(true) // 有効/無効
  createdAt            DateTime @default(now())
  updatedAt            DateTime @updatedAt

  user             User             @relation(fields: [userId], references: [id], onDelete: Cascade)
  studyLogSettings StudyLogSettings @relation(fields: [studyLogSettingsId], references: [id], onDelete: Cascade)
  completions      HabitCompletion[]

  @@index([userId])
  @@index([studyLogSettingsId])
  @@map("habits")
}

// 習慣の実行記録
model HabitCompletion {
  id        String   @id @default(cuid())
  userId    String
  habitId   String
  date      String // YYYY-MM-DD
  completed Boolean  @default(false)
  memo      String? @db.Text
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  user  User  @relation(fields: [userId], references: [id], onDelete: Cascade)
  habit Habit @relation(fields: [habitId], references: [id], onDelete: Cascade)

  @@unique([userId, habitId, date])
  @@index([userId, date])
  @@index([habitId])
  @@map("habit_completions")
}
